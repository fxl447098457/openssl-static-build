name: Build OpenSSL 3.5.5 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'openssl-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  OPENSSL_VERSION: 3.5.5

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            mingw_dir: C:\mingw32
            configure_target: mingw
            prefix: i686-w64-mingw32-
            artifact_name: openssl-3.5.5-win32-static-gcc93-sjlj
            extra_flags: ""  # 确保空值
          - arch: x64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            mingw_dir: C:\mingw64
            configure_target: mingw64
            prefix: x86_64-w64-mingw32-
            artifact_name: openssl-3.5.5-win64-static-gcc93-sjlj
            extra_flags: ""

    name: Build ${{ matrix.arch }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install 7z and Strawberry Perl
      shell: powershell
      run: |
        choco install 7zip strawberryperl -y
        Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
        refreshenv

    - name: Fix Perl Path Separator (CRITICAL FIX)
      shell: powershell
      run: |
        # ✅ 关键修复: 强制 Perl 使用 Unix 风格路径分隔符
        $env:PERL5LIB = "C:\strawberry\perl\lib"
        $env:PATH = $env:PATH -replace "C:\\strawberry\\perl\\bin", "C:/strawberry/perl/bin"
        $env:PATH = $env:PATH -replace "C:\\strawberry\\c\\bin", "C:/strawberry/c/bin"
        Write-Host "Fixed PATH for Unix-style paths: $env:PATH"

    - name: Add Perl to PATH
      shell: powershell
      run: |
        "C:/strawberry/perl/bin" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        "C:/strawberry/c/bin" | Out-File -Append -Encoding utf8 $env:GITHUB_PATH

    - name: Verify Perl Path Style
      shell: powershell
      run: |
        # 验证是否使用 Unix 风格路径
        $perlPath = (Get-Command perl).Source
        if ($perlPath -match "\\") {
          Write-Error "Perl still using Windows paths! $perlPath"
          exit 1
        }
        Write-Host "Perl using Unix paths: $perlPath"

    - name: Download MinGW Toolchain
      shell: powershell
      run: |
        Write-Host "Downloading ${{ matrix.arch }} toolchain..."
        Invoke-WebRequest -Uri "${{ matrix.toolchain_url }}" -OutFile "toolchain.7z"

    - name: Extract Toolchain
      shell: powershell
      run: |
        7z x toolchain.7z -o"${{ matrix.mingw_dir }}" -y
        if ("${{ matrix.arch }}" -eq "x86") {
          $binDir = "${{ matrix.mingw_dir }}/mingw32/bin"
        } else {
          $binDir = "${{ matrix.mingw_dir }}/mingw64/bin"
        }
        $binDir | Out-File -Append -Encoding utf8 $env:GITHUB_PATH
        Write-Host "Added to PATH: $binDir"

    - name: Download OpenSSL Source
      shell: powershell
      run: |
        $url = "https://github.com/openssl/openssl/releases/download/openssl-${{ env.OPENSSL_VERSION }}/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
        Invoke-WebRequest -Uri $url -OutFile "openssl.tar.gz"
        tar -xzf openssl.tar.gz
        dir "openssl-${{ env.OPENSSL_VERSION }}"

    - name: Configure OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        @echo on
        set INSTALL_PREFIX=%CD%/../install-${{ matrix.arch }}
        
        perl Configure ${{ matrix.configure_target }} ^
          no-apps ^
          no-async ^
          no-capieng ^
          no-deprecated ^
          no-docs ^
          no-dso ^
          no-module ^
          no-pinshared ^
          no-shared ^
          no-tests ^
          ${{ matrix.extra_flags }} ^
          --cross-compile-prefix=${{ matrix.prefix }} ^
          -D_WIN32_WINNT=0x0601 ^  # ✅ 修复: Windows 7+
          --prefix=%INSTALL_PREFIX% ^
          || exit /b 1

    - name: Build OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        @echo on
        mingw32-make -j%NUMBER_OF_PROCESSORS% || exit /b 1

    - name: Install OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        @echo on
        mingw32-make install_sw || exit /b 1

    - name: Package Artifacts
      shell: powershell
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        $installDir = "install-${{ matrix.arch }}"
        
        New-Item -ItemType Directory -Force -Path $pkgName | Out-Null
        
        Copy-Item -Path "$installDir\*" -Destination $pkgName -Recurse -Force
        
        # 修复后的 BUILD_INFO (使用 Unix 路径风格)
        $buildInfo = "OpenSSL ${{ env.OPENSSL_VERSION }} ${{ matrix.arch }} Static Library`n" +
                     "Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)`n" +
                     "Toolchain: winlibs 9.3.0-7.0.0-r3`n" +
                     "Build Date: $(Get-Date -Format `"yyyy-MM-dd HH:mm:ss UTC`")`n" +
                     "Configure Target: ${{ matrix.configure_target }}`n" +
                     "Windows Version: 0x0601 (Windows 7+)`n" +
                     "SSE2: Enabled (required by OpenSSL 3.x)"
        
        $buildInfo | Out-File -Encoding utf8 "$pkgName\BUILD_INFO.txt"
        
        7z a "$pkgName.7z" $pkgName\ | Out-Null
        Compress-Archive -Path $pkgName -DestinationPath "$pkgName.zip" -CompressionLevel Optimal

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z
        retention-days: 7

  release:
    needs: build
    runs-on: windows-latest
    if: (startsWith(github.ref, 'refs/tags/') && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: openssl-3.5.5-*-gcc93-sjlj
        merge-multiple: true

    - name: Generate Checksums
      id: checksums
      shell: powershell
      run: |
        $files = Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z"
        $content = ""
        foreach ($f in $files) {
          $hash = (Get-FileHash -Path $f.FullName -Algorithm SHA256).Hash
          $line = "$hash  $($f.Name)"
          $content += "$line`n"
          Write-Host $line
        }
        $content | Out-File -Encoding utf8 "CHECKSUMS.txt"
        
        $bodyContent = ($content -replace "`n", "<br>") -replace "`r", ""
        "content=$bodyContent" | Out-File -Append -Encoding utf8 $env:GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: OpenSSL ${{ env.OPENSSL_VERSION }} Windows (GCC 9.3 SJLJ) ${{ github.ref_name }}
        body: |
          ## OpenSSL ${{ env.OPENSSL_VERSION }} Windows 静态库 (GCC 9.3 SJLJ)

          ### 编译器信息
          - **版本**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **异常处理**: SJLJ (SetJump/LongJump)
          - **构建环境**: Windows Server 2022 (GitHub Actions)
          - **Perl**: Strawberry Perl 5.42.0 (Unix-path fixed)
          - **目标系统**: Windows 7+ (`_WIN32_WINNT=0x0601`)

          ### 包含文件
          - `openssl-3.5.5-win32-static-gcc93-sjlj`: x86 32位静态库 (**启用 SSE2**)
          - `openssl-3.5.5-win64-static-gcc93-sjlj`: x86_64 64位静态库

          ### 构建配置
          - 静态链接 (`no-shared`)
          - 禁用测试/文档 (`no-tests`, `no-docs`)
          - 禁用动态加载 (`no-dso`, `no-module`)

          ### SHA256 校验和
          ${{ steps.checksums.outputs.content }}

        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') }}
