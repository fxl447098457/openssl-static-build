name: Build OpenSSL 3.5.5 with MinGW GCC 9.3 SJLJ

on:
  push:
    tags: ['v*', 'openssl-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  OPENSSL_VERSION: 3.5.5

jobs:
  build-toolchain:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: i686
            mxe_target: i686-w64-mingw32.static
          - arch: x86_64
            mxe_target: x86_64-w64-mingw32.static
    
    name: Build GCC 9.3 SJLJ ${{ matrix.arch }}

    steps:
    - name: Install Dependencies (including mako)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf automake autopoint bash bison bzip2 flex g++ \
          g++-multilib gettext git gperf intltool libc6-dev-i386 \
          libgdk-pixbuf2.0-dev libltdl-dev libssl-dev libtool-bin \
          libxml-parser-perl lzip make openssl p7zip-full patch \
          perl pkg-config python3 python3-mako python3-setuptools \
          python-is-python3 ruby sed unzip wget xz-utils

    - name: Cache MXE Toolchain
      id: cache-mxe
      uses: actions/cache@v4
      with:
        path: ~/mxe/usr
        key: mxe-gcc93-sjlj-${{ matrix.mxe_target }}-${{ runner.os }}-v2

    - name: Clone MXE and Build GCC 9.3 with SJLJ
      if: steps.cache-mxe.outputs.cache-hit != 'true'
      run: |
        git clone https://github.com/mxe/mxe.git ~/mxe
        cd ~/mxe
        
        # 创建 settings.mk 启用 GCC 9 插件和 SJLJ
        cat > settings.mk << 'EOF'
        MXE_TARGETS := ${{ matrix.mxe_target }}
        override MXE_PLUGIN_DIRS += plugins/gcc9
        EOF
        
        # 修改 gcc9 插件启用 SJLJ
        # 注意：需要修改 plugins/gcc9/gcc9.mk 添加 --enable-sjlj-exceptions
        if [ -f plugins/gcc9/gcc9.mk ]; then
          sed -i 's/--enable-languages/--enable-sjlj-exceptions --enable-languages/' plugins/gcc9/gcc9.mk || true
        fi
        
        # 构建 GCC（这会使用 plugins/gcc9/ 下的 GCC 9.3）
        make gcc -j$(nproc)
      timeout-minutes: 180

    - name: Verify Toolchain
      run: |
        export PATH=$HOME/mxe/usr/bin:$PATH
        ${{ matrix.mxe_target }}-gcc --version
        echo "Checking exception model..."
        # 创建测试程序检查异常处理
        cat > /tmp/test_exc.cpp << 'EOF'
        #include <csetjmp>
        jmp_buf buf;
        int main() { if(!setjmp(buf)) longjmp(buf, 1); return 0; }
        EOF
        ${{ matrix.mxe_target }}-g++ /tmp/test_exc.cpp -o /tmp/test_exc.exe
        echo "Build successful with SJLJ"

    - name: Upload Toolchain
      uses: actions/upload-artifact@v4
      with:
        name: toolchain-${{ matrix.mxe_target }}-gcc93
        path: ~/mxe/usr/${{ matrix.mxe_target }}/
        retention-days: 1

  build-openssl:
    needs: build-toolchain
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86
            mxe_target: i686-w64-mingw32.static
            configure_target: mingw
            dest_dir: dist-legacy
            extra_flags: no-sse2
            artifact_name: openssl-3.5.5-win32-static-gcc93-sjlj
          - arch: x64
            mxe_target: x86_64-w64-mingw32.static
            configure_target: mingw64
            dest_dir: dist64
            extra_flags: ""
            artifact_name: openssl-3.5.5-win64-static-gcc93-sjlj
    
    name: Build OpenSSL ${{ matrix.arch }}

    steps:
    - name: Download Toolchain
      uses: actions/download-artifact@v4
      with:
        name: toolchain-${{ matrix.mxe_target }}-gcc93
        path: ~/mxe/usr/${{ matrix.mxe_target }}

    - name: Setup Environment
      run: |
        echo "$HOME/mxe/usr/bin" >> $GITHUB_PATH
        chmod +x ~/mxe/usr/bin/* 2>/dev/null || true

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y perl make

    - name: Download OpenSSL
      run: |
        wget -O openssl.tar.gz https://github.com/openssl/openssl/releases/download/openssl-${{ env.OPENSSL_VERSION }}/openssl-${{ env.OPENSSL_VERSION }}.tar.gz
        tar -xzf openssl.tar.gz
        mv openssl-${{ env.OPENSSL_VERSION }} openssl-src

    - name: Configure OpenSSL
      working-directory: openssl-src
      env:
        CC: ${{ matrix.mxe_target }}-gcc
        AR: ${{ matrix.mxe_target }}-ar
        RANLIB: ${{ matrix.mxe_target }}-ranlib
      run: |
        ./Configure ${{ matrix.configure_target }} \
          no-apps no-async no-capieng no-deprecated no-docs \
          no-dso no-module no-pinshared no-shared no-tests \
          ${{ matrix.extra_flags }} \
          --cross-compile-prefix=${{ matrix.mxe_target }}- \
          -D_WIN32_WINNT=0x0501 \
          --prefix=.

    - name: Build OpenSSL
      working-directory: openssl-src
      run: make -j$(nproc)

    - name: Install and Package
      working-directory: openssl-src
      run: |
        make DESTDIR=../${{ matrix.dest_dir }}/ install_dev
        
        # 创建构建信息
        mkdir -p ../${{ matrix.artifact_name }}
        cp -r ../${{ matrix.dest_dir }}/* ../${{ matrix.artifact_name }}/
        
        cat > ../${{ matrix.artifact_name }}/BUILD_INFO.txt << EOF
        OpenSSL ${{ env.OPENSSL_VERSION }} Windows Static Library
        Architecture: ${{ matrix.arch }}
        Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Configure: ${{ matrix.configure_target }}
        Win32 Version: 0x0501 (Windows XP+)
        EOF
        
        cd ..
        zip -r ${{ matrix.artifact_name }}.zip ${{ matrix.artifact_name }}/
        tar -czf ${{ matrix.artifact_name }}.tar.gz ${{ matrix.artifact_name }}/

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.tar.gz

  release:
    needs: build-openssl
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: openssl-3.5.5-*-gcc93-sjlj

    - name: Generate Release Notes
      run: |
        cd artifacts
        echo "## SHA256 Checksums" > ../RELEASE_BODY.md
        echo "" >> ../RELEASE_BODY.md
        find . -name "*.zip" -o -name "*.tar.gz" | sort | while read f; do
          sha256sum "$f" >> ../RELEASE_BODY.md
        done
        cd ..
        
        cat >> RELEASE_BODY.md << 'EOF'
        
        ## OpenSSL 3.5.5 Windows 静态库 (GCC 9.3 SJLJ)
        
        ### 编译器信息
        - **版本**: MinGW-w64 GCC 9.3.0
        - **异常处理**: SJLJ (SetJump/LongJump)
        - **线程模型**: POSIX
        - **目标系统**: Windows XP及以上
        
        ### SJLJ 特性说明
        SJLJ 异常处理模型允许异常跨越 Windows 系统 DLL 和回调函数，与 Visual Studio 编译的 DLL 兼容性最佳。
        
        ### 包含文件
        - `openssl-3.5.5-win32-static-gcc93-sjlj`: x86 32位静态库
        - `openssl-3.5.5-win64-static-gcc93-sjlj`: x86_64 64位静态库
        
        ### 使用方法
        解压后使用 `-I<path>/include -L<path>/lib` 链接静态库，需要额外链接 `ws2_32` 和 `crypt32`。
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name || 'v3.5.5-sjlj' }}
        name: OpenSSL ${{ env.OPENSSL_VERSION }} Windows (GCC 9.3 SJLJ) ${{ github.ref_name }}
        body_path: RELEASE_BODY.md
        draft: false
        prerelease: false
        files: |
          artifacts/**/*.zip
          artifacts/**/*.tar.gz
