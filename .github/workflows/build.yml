name: Build OpenSSL 3.5.5 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'openssl-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  OPENSSL_VERSION: 3.5.5

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            mingw_dir: C:\mingw32
            configure_target: mingw
            prefix: i686-w64-mingw32-
            artifact_name: openssl-3.5.5-win32-static-gcc93-sjlj
            extra_flags: no-sse2
          - arch: x64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            mingw_dir: C:\mingw64
            configure_target: mingw64
            prefix: x86_64-w64-mingw32-
            artifact_name: openssl-3.5.5-win64-static-gcc93-sjlj
            extra_flags: ""
    
    name: Build ${{ matrix.arch }}

    steps:
    - name: Install 7z
      run: choco install 7zip -y

    - name: Install Strawberry Perl
      run: |
        choco install strawberryperl -y
        refreshenv

    - name: Add Perl to PATH
      run: |
        echo "C:\strawberry\perl\bin" >> $env:GITHUB_PATH
        echo "C:\strawberry\c\bin" >> $env:GITHUB_PATH

    - name: Verify Perl Installation
      run: |
        perl -v
        perl -e "print 'Perl works!\n'"

    - name: Download MinGW Toolchain
      run: |
        Write-Host "Downloading ${{ matrix.arch }} toolchain..."
        Invoke-WebRequest -Uri "${{ matrix.toolchain_url }}" -OutFile "toolchain.7z"

    - name: Extract Toolchain
      run: |
        7z x toolchain.7z -o"${{ matrix.mingw_dir }}" -y
        dir "${{ matrix.mingw_dir }}"

    - name: Setup MinGW Environment
      run: |
        $mingwBin = "${{ matrix.mingw_dir }}\mingw32\bin"
        if ("${{ matrix.arch }}" -eq "x64") {
          $mingwBin = "${{ matrix.mingw_dir }}\mingw64\bin"
        }
        echo "$mingwBin" >> $env:GITHUB_PATH
        echo "MINGW_BIN=$mingwBin" >> $env:GITHUB_ENV
        & "$mingwBin\gcc.exe" --version

    - name: Verify All Tools
      run: |
        Write-Host "=== Tool Versions ==="
        perl -v | Select-Object -First 2
        ${{ matrix.prefix }}gcc --version | Select-Object -First 1
        Get-Command mingw32-make | Select-Object Source
        mingw32-make --version | Select-Object -First 1

    - name: Download OpenSSL Source
      run: |
        $url = "https://github.com/openssl/openssl/releases/download/openssl-${{ env.OPENSSL_VERSION }}/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
        Invoke-WebRequest -Uri $url -OutFile "openssl.tar.gz"
        tar -xzf openssl.tar.gz

    - name: Configure OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        set PATH=%MINGW_BIN%;C:\strawberry\perl\bin;C:\strawberry\c\bin;%PATH%
        set CC=${{ matrix.prefix }}gcc
        set AR=${{ matrix.prefix }}ar
        set RANLIB=${{ matrix.prefix }}ranlib
        
        perl Configure ${{ matrix.configure_target }} ^
          no-apps ^
          no-async ^
          no-capieng ^
          no-deprecated ^
          no-docs ^
          no-dso ^
          no-module ^
          no-pinshared ^
          no-shared ^
          no-tests ^
          ${{ matrix.extra_flags }} ^
          --cross-compile-prefix=${{ matrix.prefix }} ^
          -D_WIN32_WINNT=0x0501 ^
          --prefix=C:/openssl-${{ matrix.arch }}
        
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%

    - name: Build OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        set PATH=%MINGW_BIN%;C:\strawberry\perl\bin;%PATH%
        mingw32-make -j%NUMBER_OF_PROCESSORS%
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%

    - name: Install OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      shell: cmd
      run: |
        set PATH=%MINGW_BIN%;C:\strawberry\perl\bin;%PATH%
        mingw32-make install_sw DESTDIR=..
        if %ERRORLEVEL% neq 0 exit /b %ERRORLEVEL%

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        New-Item -ItemType Directory -Force -Path $pkgName
        
        $installDir = "openssl-${{ matrix.arch }}"
        if (Test-Path "$installDir\usr\local") {
          Copy-Item -Path "$installDir\usr\local\*" -Destination $pkgName -Recurse -Force
        } elseif (Test-Path "$installDir") {
          Copy-Item -Path "$installDir\*" -Destination $pkgName -Recurse -Force
        }
        
        @"
        OpenSSL ${{ env.OPENSSL_VERSION }} ${{ matrix.arch }} Static Library
        Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)
        Toolchain: winlibs 9.3.0-7.0.0-r3
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Configure: ${{ matrix.configure_target }}
        Win32 Version: 0x0501 (Windows XP+)
        "@ | Out-File -Encoding utf8 "$pkgName\BUILD_INFO.txt"
        
        7z a "$pkgName.7z" $pkgName\
        Compress-Archive -Path $pkgName -DestinationPath "$pkgName.zip"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: openssl-3.5.5-*-gcc93-sjlj

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
        Get-FileHash -Algorithm SHA256 | 
        ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
        Out-File -Encoding utf8 $checksumFile
        
        $content = Get-Content $checksumFile -Raw
        Write-Host "Checksums:"
        Write-Host $content
        
        # 设置多行输出
        echo "content<<EOF" >> $env:GITHUB_OUTPUT
        echo "$content" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: OpenSSL ${{ env.OPENSSL_VERSION }} Windows (GCC 9.3 SJLJ) ${{ github.ref_name }}
        body: |
          ## OpenSSL 3.5.5 Windows 静态库 (GCC 9.3 SJLJ)
          
          ### 编译器信息
          - **版本**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **异常处理**: SJLJ (SetJump/LongJump)
          - **构建环境**: Windows Server 2022 (GitHub Actions)
          - **Perl**: Strawberry Perl 5.32+
          
          ### 包含文件
          - `openssl-3.5.5-win32-static-gcc93-sjlj`: x86 32位静态库（禁用 SSE2）
          - `openssl-3.5.5-win64-static-gcc93-sjlj`: x86_64 64位静态库
          
          ### SHA256 校验和
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
        prerelease: false
