name: Build OpenSSL 3.5.5 Windows (GCC 9.3 SJLJ)

on:
  push:
    tags: ['v*', 'openssl-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  OPENSSL_VERSION: 3.5.5

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msystem: MINGW32
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-i686-9.3.0-7.0.0-r3-sjlj.7z
            configure_target: mingw
            prefix: i686-w64-mingw32-
            artifact_name: openssl-3.5.5-win32-static-gcc93-sjlj
            extra_flags: no-sse2
          - arch: x64
            msystem: MINGW64
            toolchain_url: https://github.com/brechtsanders/winlibs_mingw/releases/download/9.3.0-7.0.0-sjlj-r3/winlibs-mingw-w64-x86_64-9.3.0-7.0.0-r3-sjlj.7z
            configure_target: mingw64
            prefix: x86_64-w64-mingw32-
            artifact_name: openssl-3.5.5-win64-static-gcc93-sjlj
            extra_flags: ""
    
    name: Build ${{ matrix.arch }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install 7z
      run: choco install 7zip -y

    - name: Download winlibs Toolchain
      run: |
        Invoke-WebRequest -Uri "${{ matrix.toolchain_url }}" -OutFile "toolchain.7z"
        7z x toolchain.7z -o"C:\winlibs" -y

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          mingw-w64-${{ matrix.arch == 'x86' && 'i686' || 'x86_64' }}-toolchain
          mingw-w64-${{ matrix.arch == 'x86' && 'i686' || 'x86_64' }}-perl
          make
          tar

    - name: Download OpenSSL Source
      shell: msys2 {0}
      run: |
        curl -L -o openssl.tar.gz "https://github.com/openssl/openssl/releases/download/openssl-${{ env.OPENSSL_VERSION }}/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
        tar -xzf openssl.tar.gz

    - name: Configure OpenSSL
      shell: msys2 {0}
      run: |
        cd openssl-${{ env.OPENSSL_VERSION }}
        
        # 使用 winlibs 的 GCC 而不是 MSYS2 自带的
        export CC="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin/${{ matrix.prefix }}gcc"
        export AR="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin/${{ matrix.prefix }}ar"
        export RANLIB="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin/${{ matrix.prefix }}ranlib"
        export WINDRES="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin/${{ matrix.prefix }}windres"
        
        # 添加到 PATH 最前面，确保优先使用 winlibs
        export PATH="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin:$PATH"
        
        echo "Using GCC:"
        ${{ matrix.prefix }}gcc --version
        
        perl Configure ${{ matrix.configure_target }} \
          no-apps \
          no-async \
          no-capieng \
          no-deprecated \
          no-docs \
          no-dso \
          no-module \
          no-pinshared \
          no-shared \
          no-tests \
          ${{ matrix.extra_flags }} \
          --cross-compile-prefix=${{ matrix.prefix }} \
          -D_WIN32_WINNT=0x0501 \
          --prefix=/openssl-${{ matrix.arch }}

    - name: Build OpenSSL
      shell: msys2 {0}
      run: |
        cd openssl-${{ env.OPENSSL_VERSION }}
        export PATH="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin:$PATH"
        make -j$(nproc)

    - name: Install OpenSSL
      shell: msys2 {0}
      run: |
        cd openssl-${{ env.OPENSSL_VERSION }}
        export PATH="/c/winlibs/${{ matrix.arch == 'x86' && 'mingw32' || 'mingw64' }}/bin:$PATH"
        make install_sw DESTDIR=/

    - name: Package Artifacts
      shell: pwsh
      run: |
        $pkgName = "${{ matrix.artifact_name }}"
        $sourcePath = "C:\msys64\openssl-${{ matrix.arch }}"
        
        # 如果 MSYS2 安装到不同路径，需要调整
        if (-not (Test-Path $sourcePath)) {
          $sourcePath = "openssl-${{ matrix.arch }}"
        }
        
        New-Item -ItemType Directory -Force -Path $pkgName
        Copy-Item -Path "$sourcePath\*" -Destination $pkgName -Recurse -Force
        
        @"
        OpenSSL ${{ env.OPENSSL_VERSION }} ${{ matrix.arch }} Static Library
        Compiler: MinGW-w64 GCC 9.3.0 (SJLJ Exception Model)
        Toolchain: winlibs 9.3.0-7.0.0-r3
        Build Date: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
        Configure: ${{ matrix.configure_target }}
        Win32 Version: 0x0501 (Windows XP+)
        "@ | Out-File -Encoding utf8 "$pkgName\BUILD_INFO.txt"
        
        7z a "$pkgName.7z" $pkgName\
        Compress-Archive -Path $pkgName -DestinationPath "$pkgName.zip"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z

  release:
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.create_release == 'true'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: openssl-3.5.5-*-gcc93-sjlj

    - name: Generate Checksums
      shell: pwsh
      id: checksums
      run: |
        $checksumFile = "CHECKSUMS.txt"
        
        Get-ChildItem -Path "./artifacts" -Recurse -Include "*.zip","*.7z" | 
        Get-FileHash -Algorithm SHA256 | 
        ForEach-Object { "$($_.Hash)  $(Split-Path $_.Path -Leaf)" } | 
        Out-File -Encoding utf8 $checksumFile
        
        $content = Get-Content $checksumFile -Raw
        
        echo "content<<EOF" >> $env:GITHUB_OUTPUT
        echo "$content" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: OpenSSL ${{ env.OPENSSL_VERSION }} Windows (GCC 9.3 SJLJ) ${{ github.ref_name }}
        body: |
          ## OpenSSL 3.5.5 Windows 静态库 (GCC 9.3 SJLJ)
          
          ### 编译器信息
          - **版本**: MinGW-w64 GCC 9.3.0 (winlibs 9.3.0-7.0.0-r3)
          - **异常处理**: SJLJ (SetJump/LongJump)
          - **构建环境**: Windows Server 2022 + MSYS2
          
          ### 包含文件
          - `openssl-3.5.5-win32-static-gcc93-sjlj`: x86 32位静态库
          - `openssl-3.5.5-win64-static-gcc93-sjlj`: x86_64 64位静态库
          
          ### SHA256 校验和
          ```
          ${{ steps.checksums.outputs.content }}
          ```
        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
        prerelease: false
