name: Build OpenSSL 3.5.5 Windows (Cross-Compile on Linux)

on:
  push:
    tags: ['v*', 'openssl-*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release?'
        default: 'true'
        type: choice
        options: ['true', 'false']

env:
  OPENSSL_VERSION: 3.5.5

jobs:
  build:
    runs-on: ubuntu-20.04  # ✅ GCC 9.3 默认环境
    strategy:
      matrix:
        include:
          - arch: x86
            host: i686-w64-mingw32
            configure_target: mingw
            artifact_name: openssl-3.5.5-win32-static-gcc93
            extra_flags: ""
          - arch: x64
            host: x86_64-w64-mingw32
            configure_target: mingw64
            artifact_name: openssl-3.5.5-win64-static-gcc93
            extra_flags: ""

    name: Build ${{ matrix.arch }} (Linux Cross-Compile)

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install MinGW-w64 Cross-Toolchain (GCC 9.3)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          mingw-w64 \
          gcc-mingw-w64-${{ matrix.arch == 'x86' && 'i686' || 'x86-64' }} \
          g++-mingw-w64-${{ matrix.arch == 'x86' && 'i686' || 'x86-64' }} \
          make \
          perl
        
        # 验证工具链版本 (Ubuntu 20.04 默认提供 GCC 9.3)
        ${{ matrix.host }}-gcc --version | head -1

    - name: Download OpenSSL Source
      run: |
        wget "https://github.com/openssl/openssl/releases/download/openssl-${{ env.OPENSSL_VERSION }}/openssl-${{ env.OPENSSL_VERSION }}.tar.gz"
        tar -xzf openssl-${{ env.OPENSSL_VERSION }}.tar.gz
        cd openssl-${{ env.OPENSSL_VERSION }}
        ls -la

    - name: Configure OpenSSL (Cross-Compile)
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      run: |
        ./Configure ${{ matrix.configure_target }} \
          --cross-compile-prefix=${{ matrix.host }}- \
          no-apps \
          no-async \
          no-capieng \
          no-deprecated \
          no-docs \
          no-dso \
          no-module \
          no-pinshared \
          no-shared \
          no-tests \
          ${{ matrix.extra_flags }} \
          -D_WIN32_WINNT=0x0601 \
          --prefix=/tmp/install-${{ matrix.arch }} \
          --openssldir=/tmp/install-${{ matrix.arch }}/ssl
        
        # 验证 Makefile 生成
        test -f Makefile && echo "✅ Makefile created successfully"

    - name: Build OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      run: |
        make -j$(nproc) || exit 1

    - name: Install OpenSSL
      working-directory: openssl-${{ env.OPENSSL_VERSION }}
      run: |
        make install_sw DESTDIR=$(pwd)/../install-root || exit 1

    - name: Package Artifacts
      run: |
        pkg_name="${{ matrix.artifact_name }}"
        install_root="install-root/tmp/install-${{ matrix.arch }}"
        
        mkdir -p "$pkg_name"/{lib,include,bin}
        
        # 复制库文件
        cp -v "$install_root"/lib/*.a "$pkg_name/lib/" 2>/dev/null || true
        cp -v "$install_root"/lib/*.lib "$pkg_name/lib/" 2>/dev/null || true
        
        # 复制头文件
        cp -rv "$install_root"/include/openssl "$pkg_name/include/" 2>/dev/null || true
        
        # 创建 BUILD_INFO
        cat > "$pkg_name/BUILD_INFO.txt" <<EOF
OpenSSL ${{ env.OPENSSL_VERSION }} ${{ matrix.arch }} Static Library
Cross-Compiled on: Ubuntu 20.04 (GitHub Actions)
Host Compiler: ${{ matrix.host }}-gcc (GCC 9.3.0)
Target OS: Windows 7+ (_WIN32_WINNT=0x0601)
Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
Configure Target: ${{ matrix.configure_target }}
Static Linking: Enabled (no-shared)
SSE2: Enabled (required by OpenSSL 3.x)
Exception Model: N/A (static library has no unwind tables)
EOF
        
        # 打包
        7z a "$pkg_name.7z" "$pkg_name/"
        zip -r "$pkg_name.zip" "$pkg_name/"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: |
          ${{ matrix.artifact_name }}.zip
          ${{ matrix.artifact_name }}.7z
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: (startsWith(github.ref, 'refs/tags/') && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: openssl-3.5.5-*-gcc93
        merge-multiple: true

    - name: Generate Checksums
      id: checksums
      run: |
        find ./artifacts -type f \( -name "*.zip" -o -name "*.7z" \) | while read f; do
          sha256sum "$f" | sed 's|\.\/artifacts/||'
        done > CHECKSUMS.txt
        
        # 准备 Release Body 内容
        content=$(sed 's/$/<br>/' CHECKSUMS.txt | tr -d '\n')
        echo "content=$content" >> $GITHUB_OUTPUT
        
        cat CHECKSUMS.txt

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: OpenSSL ${{ env.OPENSSL_VERSION }} Windows Static Libraries (GCC 9.3 Cross-Compiled)
        body: |
          ## OpenSSL ${{ env.OPENSSL_VERSION }} Windows 静态库 (Linux 交叉编译)

          ### 编译环境
          - **Host OS**: Ubuntu 20.04 (GitHub Actions)
          - **Compiler**: MinGW-w64 GCC 9.3.0
          - **Targets**: 
            - `i686-w64-mingw32` (32-bit, DWARF exception model)
            - `x86_64-w64-mingw32` (64-bit, SEH exception model)
          - **Perl**: Native Linux Perl (Unix paths, no compatibility issues)

          ### 兼容性说明
          > ✅ **静态库与异常模型无关**  
          > 本库使用标准 MinGW-w64 编译，与 **winlibs GCC 9.3 SJLJ** 编译的程序**完全兼容**：
          > - 静态库（`.a`/`.lib`）不包含异常处理表
          > - 仅可执行文件/动态库受异常模型影响
          > - 调用约定（cdecl）完全一致，可安全链接

          ### 包含文件
          - `openssl-3.5.5-win32-static-gcc93`: x86 32位静态库
          - `openssl-3.5.5-win64-static-gcc93`: x86_64 64位静态库
          - 头文件 (`include/openssl/*.h`)
          - 构建信息 (`BUILD_INFO.txt`)

          ### 构建配置
          - 静态链接 (`no-shared`)
          - 禁用测试/文档 (`no-tests`, `no-docs`)
          - 禁用动态加载 (`no-dso`, `no-module`)
          - Windows 7+ 支持 (`_WIN32_WINNT=0x0601`)

          ### SHA256 校验和
          ${{ steps.checksums.outputs.content }}

        files: |
          artifacts/**/*.zip
          artifacts/**/*.7z
          CHECKSUMS.txt
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') }}
